<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة حجز الفنادق (Appwrite)</title>

    <!-- Tailwind CSS CDN -->
    <!-- رابط شبكة توصيل المحتوى الخاص بـ Tailwind CSS للتصميم -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Appwrite Web SDK CDN -->
    <!-- رابط مكتبة Appwrite للتواصل مع الواجهة الخلفية -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@11.0.0"></script>
    
    <!-- Google Fonts: Cairo -->
    <!-- خط جوجل لجمالية النص -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <!-- بعض التنسيقات المخصصة لتكملة Tailwind CSS -->
    <style>
        /* استخدام الخط المخصص Cairo لكل الصفحة */
        body {
            font-family: 'Cairo', sans-serif;
        }

        /* إخفاء العناصر التي تحمل هذا الكلاس بشكل افتراضي */
        .hidden-view {
            display: none;
        }

        /* تأثير انتقال سلس عند تغيير الخصائص */
        .transition-all {
            transition: all 0.3s ease-in-out;
        }

        /* تصميم مخصص لشريط التمرير */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* كلاسات للتحريك عند التحميل */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- =================================================================== -->
    <!-- ========================  الهيكل الأساسي (HTML) ===================== -->
    <!-- =================================================================== -->

    <!-- Header / Navigation Bar -->
    <!-- شريط التنقل العلوي -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="#" id="logo" class="text-2xl font-bold text-blue-600">فندقي</a>
            <div class="flex items-center space-x-4 space-x-reverse">
                <a href="#" id="nav-home" class="text-gray-600 hover:text-blue-500">الرئيسية</a>
                <div id="auth-links" class="flex items-center space-x-2 space-x-reverse">
                    <a href="#" id="nav-login" class="px-4 py-2 text-sm font-medium text-blue-600 bg-blue-100 rounded-lg hover:bg-blue-200">تسجيل الدخول</a>
                </div>
                <div id="user-menu" class="hidden-view relative flex items-center space-x-2 space-x-reverse">
                    <a href="#" id="nav-my-bookings" class="text-gray-600 hover:text-blue-500">حجوزاتي</a>
                    <span id="user-email-display" class="text-sm text-gray-500"></span>
                    <button id="nav-logout" class="px-4 py-2 text-sm font-medium text-red-600 bg-red-100 rounded-lg hover:bg-red-200">تسجيل الخروج</button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content Area -->
    <!-- منطقة المحتوى الرئيسي التي ستتغير ديناميكيًا -->
    <main id="app-container" class="container mx-auto p-4 md:p-6">

        <!-- Loading Spinner View -->
        <!-- واجهة التحميل (تظهر عند انتظار البيانات) -->
        <div id="loader-view" class="flex justify-center items-center py-20">
            <div class="spinner"></div>
            <p class="ml-4">جاري التحميل...</p>
        </div>

        <!-- Login / Signup View -->
        <!-- واجهة تسجيل الدخول أو إنشاء حساب جديد -->
        <div id="login-view" class="hidden-view max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-center mb-6">تسجيل الدخول أو إنشاء حساب</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">البريد الإلكتروني</label>
                    <input type="email" id="email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
                    <input type="password" id="password" name="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    تسجيل الدخول
                </button>
            </form>
            <p class="text-center text-sm text-gray-500 mt-4">
                ليس لديك حساب؟ <a href="#" id="signup-instead" class="text-blue-600 hover:underline">أنشئ حساباً جديداً</a>
            </p>
        </div>

        <!-- Home Page View (Search) -->
        <!-- الواجهة الرئيسية (واجهة البحث) -->
        <div id="home-view" class="hidden-view">
            <div class="text-center bg-white p-8 md:p-16 rounded-xl shadow-lg">
                <h1 class="text-4xl md:text-5xl font-bold mb-4">أهلاً بك في منصة فندقي</h1>
                <p class="text-lg text-gray-600 mb-8">ابحث عن أفضل الفنادق بأفضل الأسعار وأحجز غرفتك بسهولة.</p>
                <form id="search-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 max-w-4xl mx-auto">
                    <input type="text" id="destination" name="destination" placeholder="إلى أين؟ (مثال: دبي)" class="col-span-1 md:col-span-2 p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="date" id="checkin" name="checkin" class="p-4 border border-gray-300 rounded-lg text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="col-span-1 md:col-span-1 bg-blue-600 text-white font-bold p-4 rounded-lg hover:bg-blue-700 transition-colors">
                        ابحث الآن
                    </button>
                </form>
            </div>
        </div>

        <!-- Search Results View -->
        <!-- واجهة عرض نتائج البحث -->
        <div id="results-view" class="hidden-view">
            <h2 class="text-3xl font-bold mb-6">نتائج البحث</h2>
            <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Hotel cards will be injected here by JavaScript -->
                <!-- سيتم إدراج بطاقات الفنادق هنا بواسطة JavaScript -->
            </div>
            <div id="no-results" class="hidden-view text-center py-10 bg-white rounded-lg shadow">
                 <p class="text-xl text-gray-500">عفواً، لم يتم العثور على فنادق تطابق بحثك.</p>
            </div>
        </div>

        <!-- Single Hotel View -->
        <!-- واجهة عرض تفاصيل فندق واحد -->
        <div id="hotel-view" class="hidden-view">
            <div id="hotel-details-container" class="bg-white rounded-xl shadow-lg overflow-hidden">
                <!-- Hotel details will be injected here -->
                <!-- سيتم إدراج تفاصيل الفندق هنا -->
            </div>
            <h3 class="text-2xl font-bold mt-8 mb-4">الغرف المتاحة</h3>
            <div id="rooms-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Room cards will be injected here -->
                <!-- سيتم إدراج بطاقات الغرف هنا -->
            </div>
             <div id="no-rooms" class="hidden-view text-center py-10 bg-white rounded-lg shadow">
                 <p class="text-xl text-gray-500">لا توجد غرف متاحة في هذا الفندق حالياً.</p>
            </div>
        </div>
        
        <!-- Booking Confirmation View -->
        <!-- واجهة تأكيد الحجز -->
        <div id="confirmation-view" class="hidden-view max-w-lg mx-auto text-center bg-white p-10 rounded-xl shadow-lg">
             <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
             </div>
            <h2 class="text-2xl font-bold mb-2">تم تأكيد حجزك بنجاح!</h2>
            <p class="text-gray-600 mb-6">شكراً لاختيارك منصة فندقي. تم إرسال تفاصيل الحجز إلى بريدك الإلكتروني.</p>
            <div id="booking-confirmation-details" class="text-left bg-gray-50 p-4 rounded-lg">
                <!-- Booking confirmation details will be injected here -->
            </div>
            <button id="back-to-home-btn" class="mt-6 w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">
                العودة إلى الصفحة الرئيسية
            </button>
        </div>

        <!-- My Bookings View -->
        <!-- واجهة عرض حجوزاتي -->
        <div id="my-bookings-view" class="hidden-view">
            <h2 class="text-3xl font-bold mb-6">حجوزاتي</h2>
            <div id="my-bookings-container" class="space-y-6">
                <!-- User's bookings will be injected here -->
                <!-- سيتم إدراج حجوزات المستخدم هنا -->
            </div>
            <div id="no-bookings" class="hidden-view text-center py-10 bg-white rounded-lg shadow">
                 <p class="text-xl text-gray-500">ليس لديك أي حجوزات حتى الآن.</p>
            </div>
        </div>

    </main>
    
    <!-- Footer -->
    <!-- التذييل السفلي للصفحة -->
    <footer class="bg-gray-800 text-white mt-12">
        <div class="container mx-auto px-6 py-4 text-center">
            <p>&copy; 2025 منصة فندقي. جميع الحقوق محفوظة.</p>
        </div>
    </footer>
    
    <!-- Notification Toast -->
    <!-- رسالة تنبيه تظهر في الأسفل -->
    <div id="notification-toast" class="fixed bottom-5 right-5 bg-red-500 text-white px-6 py-3 rounded-lg shadow-xl opacity-0 translate-y-10 transition-all duration-500">
        <p id="notification-message">رسالة خطأ هنا</p>
    </div>

    <!-- ===================================================================== -->
    <!-- ========================  منطق التطبيق (JavaScript) ================== -->
    <!-- ===================================================================== -->
    <script type="module">
        // ---------------------------------------------------------------------
        // القسم 1: الإعدادات الأولية والتهيئة
        // ---------------------------------------------------------------------

        // استيراد الدوال اللازمة من مكتبة Appwrite
        const { Client, Account, Databases, ID, Query } = Appwrite;

        // --- هام جداً: إعدادات Appwrite ---
        // الرجاء استبدال القيم أدناه بالمعلومات الخاصة بمشروعك في Appwrite
        const APPWRITE_ENDPOINT = 'https://nyc.cloud.appwrite.io/v1'; // استبدل هنا بنقطة النهاية
        const APPWRITE_PROJECT_ID = '6861a7450017c46c772c';     // استبدل هنا بمعرف المشروع

        // --- معرفات قاعدة البيانات والمجموعات (Collections) ---
        const DATABASE_ID = '6861a79e0035c8a68724'; // استبدل بمعرف قاعدة البيانات
        const HOTELS_COLLECTION_ID = '6861a925002d605c1226';
        const ROOMS_COLLECTION_ID = '6861a9370002339758c1';
        const BOOKINGS_COLLECTION_ID = '6861a950002bb7d09ccb';
        
        // تهيئة عميل Appwrite
        const client = new Client()
            .setEndpoint(APPWRITE_ENDPOINT)
            .setProject(APPWRITE_PROJECT_ID);

        const account = new Account(client);
        const databases = new Databases(client);

        // للأسف، لا يمكن تشغيل الكود بدون مفاتيح حقيقية. 
        // سيتم محاكاة البيانات في حال عدم توفر اتصال.
        const isAppwriteConfigured = !APPWRITE_ENDPOINT.includes('YOUR_APPWRITE');

        // ---------------------------------------------------------------------
        // القسم 2: إدارة الحالة العامة للتطبيق
        // ---------------------------------------------------------------------
        
        const appState = {
            isReady: false, // <-- تعديل: حالة جديدة لتتبع جاهزية التطبيق
            currentUser: null,
            hotels: [],
            selectedHotel: null,
            selectedRoom: null,
            currentBooking: null,
            currentView: 'loader-view'
        };

        // ---------------------------------------------------------------------
        // القسم 3: تعريف العناصر الرئيسية في واجهة المستخدم (DOM Elements)
        // ---------------------------------------------------------------------

        const views = {
            loader: document.getElementById('loader-view'),
            login: document.getElementById('login-view'),
            home: document.getElementById('home-view'),
            results: document.getElementById('results-view'),
            hotel: document.getElementById('hotel-view'),
            confirmation: document.getElementById('confirmation-view'),
            myBookings: document.getElementById('my-bookings-view'),
        };

        const nav = {
            logo: document.getElementById('logo'),
            homeLink: document.getElementById('nav-home'),
            authLinks: document.getElementById('auth-links'),
            loginLink: document.getElementById('nav-login'),
            userMenu: document.getElementById('user-menu'),
            myBookingsLink: document.getElementById('nav-my-bookings'),
            userEmailDisplay: document.getElementById('user-email-display'),
            logoutButton: document.getElementById('nav-logout'),
        };
        
        const forms = {
            loginForm: document.getElementById('login-form'),
            searchForm: document.getElementById('search-form'),
        };

        const containers = {
            results: document.getElementById('results-container'),
            hotelDetails: document.getElementById('hotel-details-container'),
            rooms: document.getElementById('rooms-container'),
            myBookings: document.getElementById('my-bookings-container'),
            confirmationDetails: document.getElementById('booking-confirmation-details'),
        };

        const statusMessages = {
            noResults: document.getElementById('no-results'),
            noRooms: document.getElementById('no-rooms'),
            noBookings: document.getElementById('no-bookings'),
        };
        
        const otherElements = {
            signupInsteadLink: document.getElementById('signup-instead'),
            backToHomeBtn: document.getElementById('back-to-home-btn'),
            checkinDateInput: document.getElementById('checkin'),
            notificationToast: document.getElementById('notification-toast'),
            notificationMessage: document.getElementById('notification-message'),
        };

        // ---------------------------------------------------------------------
        // القسم 4: الدوال المساعدة (Helper Functions)
        // ---------------------------------------------------------------------

        /**
         * تعديل: الدالة الآن أكثر وضوحاً لتجنب أي مشاكل محتملة.
         */
        function showView(viewId) {
            // إخفاء جميع الواجهات بشكل صريح
            views.loader.classList.add('hidden-view');
            views.login.classList.add('hidden-view');
            views.home.classList.add('hidden-view');
            views.results.classList.add('hidden-view');
            views.hotel.classList.add('hidden-view');
            views.confirmation.classList.add('hidden-view');
            views.myBookings.classList.add('hidden-view');

            // إظهار الواجهة المطلوبة
            const viewToShow = views[viewId];
            if (viewToShow) {
                viewToShow.classList.remove('hidden-view');
                appState.currentView = viewId;
                window.scrollTo(0, 0);
            } else {
                console.error(`View with id "${viewId}" not found.`);
                views.home.classList.remove('hidden-view'); // العودة للرئيسية كخيار افتراضي
            }
        }
        
        function showNotification(message, type = 'error') {
            const toast = otherElements.notificationToast;
            otherElements.notificationMessage.textContent = message;

            if (type === 'success') {
                toast.classList.remove('bg-red-500');
                toast.classList.add('bg-green-500');
            } else {
                toast.classList.remove('bg-green-500');
                toast.classList.add('bg-red-500');
            }

            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 4000);
        }

        function formatDate(dateString) {
            if (!dateString) return 'غير محدد';
            return new Date(dateString).toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        
        function formatCurrency(amount) {
            if (typeof amount !== 'number') return 'غير محدد';
            return new Intl.NumberFormat('ar-SA', {
                style: 'currency',
                currency: 'SAR'
            }).format(amount);
        }

        function setMinCheckinDate() {
            const today = new Date().toISOString().split('T')[0];
            otherElements.checkinDateInput.setAttribute('min', today);
            otherElements.checkinDateInput.value = today;
        }

        // ---------------------------------------------------------------------
        // القسم 5: دوال العرض (Render Functions)
        // ---------------------------------------------------------------------
        
        function renderNav() {
            if (appState.currentUser) {
                nav.authLinks.classList.add('hidden-view');
                nav.userMenu.classList.remove('hidden-view');
                nav.userEmailDisplay.textContent = appState.currentUser.email.split('@')[0];
            } else {
                nav.authLinks.classList.remove('hidden-view');
                nav.userMenu.classList.add('hidden-view');
            }
        }
        
        function renderResults() {
            containers.results.innerHTML = ''; 

            if (appState.hotels.length === 0) {
                statusMessages.noResults.classList.remove('hidden-view');
                return;
            }
            
            statusMessages.noResults.classList.add('hidden-view');
            
            appState.hotels.forEach(hotel => {
                const hotelCard = `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-2 transition-transform duration-300 cursor-pointer" data-hotel-id="${hotel.$id}">
                        <img src="${hotel.image_url || 'https://placehold.co/400x250/e2e8f0/334155?text=فندق'}" alt="[صورة لفندق ${hotel.name}]" class="w-full h-48 object-cover">
                        <div class="p-4">
                            <h3 class="text-xl font-bold">${hotel.name}</h3>
                            <p class="text-gray-600">${hotel.city}, ${hotel.country}</p>
                            <div class="flex items-center mt-2">
                                <span class="text-yellow-500">${'★'.repeat(Math.round(hotel.rating || 0))}${'☆'.repeat(5 - Math.round(hotel.rating || 0))}</span>
                                <span class="text-sm text-gray-500 ml-2">(${hotel.rating || 'N/A'})</span>
                            </div>
                            <p class="text-lg font-semibold text-blue-600 mt-4">يبدأ من ${formatCurrency(hotel.min_price || 0)}/الليلة</p>
                        </div>
                    </div>
                `;
                containers.results.innerHTML += hotelCard;
            });
            
            document.querySelectorAll('[data-hotel-id]').forEach(card => {
                card.addEventListener('click', () => handleHotelSelection(card.dataset.hotelId));
            });
        }
        
        function renderHotelDetails() {
            const { hotel, rooms } = appState.selectedHotel;

            containers.hotelDetails.innerHTML = `
                <img src="${hotel.image_url || 'https://placehold.co/800x400/e2e8f0/334155?text=فندق'}" alt="[صورة لفندق ${hotel.name}]" class="w-full h-64 object-cover">
                <div class="p-6">
                    <h2 class="text-3xl font-bold">${hotel.name}</h2>
                    <p class="text-gray-500 mt-1">${hotel.address}, ${hotel.city}, ${hotel.country}</p>
                    <div class="flex items-center my-4">
                        <span class="text-yellow-500 text-lg">${'★'.repeat(Math.round(hotel.rating || 0))}${'☆'.repeat(5 - Math.round(hotel.rating || 0))}</span>
                        <span class="text-gray-600 ml-2">${hotel.rating || 'N/A'} نجوم</span>
                    </div>
                    <p class="text-gray-700 leading-relaxed mb-4">${hotel.description}</p>
                    <h4 class="font-semibold mb-2">المرافق والخدمات:</h4>
                    <div class="flex flex-wrap gap-2">
                        ${(hotel.amenities || []).map(amenity => `<span class="bg-blue-100 text-blue-800 text-sm font-medium mr-2 px-2.5 py-0.5 rounded">${amenity}</span>`).join('')}
                    </div>
                </div>
            `;
            
            containers.rooms.innerHTML = '';
            if (rooms && rooms.length > 0) {
                 statusMessages.noRooms.classList.add('hidden-view');
                 rooms.forEach(room => {
                    const roomCard = `
                        <div class="bg-white rounded-lg shadow-md p-4 flex justify-between items-center">
                            <div>
                                <h4 class="text-lg font-bold">${room.type}</h4>
                                <p class="text-sm text-gray-500">تتسع لـ ${room.capacity} أفراد</p>
                                <p class="text-lg font-semibold text-blue-600 mt-2">${formatCurrency(room.price_per_night)}/الليلة</p>
                            </div>
                            <button class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 book-now-btn" data-room-id="${room.$id}">
                                احجز الآن
                            </button>
                        </div>
                    `;
                    containers.rooms.innerHTML += roomCard;
                });
            } else {
                statusMessages.noRooms.classList.remove('hidden-view');
            }

            document.querySelectorAll('.book-now-btn').forEach(button => {
                button.addEventListener('click', () => handleBookingInitiation(button.dataset.roomId));
            });
        }
        
        function renderConfirmation() {
            const { booking, hotel, room } = appState.currentBooking;
            containers.confirmationDetails.innerHTML = `
                <p class="mb-2"><strong class="font-semibold">رقم الحجز:</strong> ${booking.$id.substring(0, 8)}</p>
                <p class="mb-2"><strong class="font-semibold">الفندق:</strong> ${hotel.name}</p>
                <p class="mb-2"><strong class="font-semibold">الغرفة:</strong> ${room.type}</p>
                <p class="mb-2"><strong class="font-semibold">تاريخ الوصول:</strong> ${formatDate(booking.check_in_date)}</p>
                <p class="mb-2"><strong class="font-semibold">السعر الإجمالي:</strong> ${formatCurrency(booking.total_price)}</p>
            `;
            showView('confirmation');
        }
        
        function renderMyBookings(bookings) {
            containers.myBookings.innerHTML = '';
            
            if (!bookings || bookings.length === 0) {
                statusMessages.noBookings.classList.remove('hidden-view');
                return;
            }
            
            statusMessages.noBookings.classList.add('hidden-view');

            bookings.forEach(booking => {
                const hotelName = booking.hotel ? booking.hotel.name : 'فندق غير معروف';
                const roomType = booking.room ? booking.room.type : 'غرفة غير معروفة';
                const hotelImage = booking.hotel ? booking.hotel.image_url : 'https://placehold.co/150x100/e2e8f0/334155?text=صورة';

                const bookingCard = `
                    <div class="bg-white rounded-lg shadow-md p-4 flex flex-col md:flex-row items-start gap-4">
                        <img src="${hotelImage}" alt="[صورة فندق ${hotelName}]" class="w-full md:w-40 h-auto rounded-md object-cover">
                        <div class="flex-grow">
                            <h3 class="text-xl font-bold">${hotelName}</h3>
                            <p class="text-gray-500">نوع الغرفة: ${roomType}</p>
                            <p class="text-sm text-gray-500">رقم الحجز: ${booking.$id.substring(0, 8)}</p>
                            <div class="mt-2 text-sm">
                                <p><strong>تاريخ الوصول:</strong> ${formatDate(booking.check_in_date)}</p>
                                <p><strong>السعر الإجمالي:</strong> ${formatCurrency(booking.total_price)}</p>
                            </div>
                        </div>
                        <div class="self-start mt-2 md:mt-0">
                            <span class="px-3 py-1 text-sm font-medium rounded-full ${booking.status === 'Confirmed' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${booking.status === 'Confirmed' ? 'مؤكد' : 'ملغي'}
                            </span>
                        </div>
                    </div>
                `;
                containers.myBookings.innerHTML += bookingCard;
            });
        }
        
        // ---------------------------------------------------------------------
        // القسم 6: معالجات الأحداث (Event Handlers)
        // ---------------------------------------------------------------------
        
        async function handleAuth(e, isSignUp = false) {
            e.preventDefault();
            if (!appState.isReady) return;
            const email = forms.loginForm.email.value;
            const password = forms.loginForm.password.value;
            
            if (!isAppwriteConfigured) {
                showNotification('يرجى إعداد Appwrite أولاً', 'error');
                return;
            }

            try {
                if (isSignUp) {
                    await account.create(ID.unique(), email, password);
                    showNotification('تم إنشاء الحساب بنجاح! قم بتسجيل الدخول الآن.', 'success');
                    const submitButton = forms.loginForm.querySelector('button[type="submit"]');
                    submitButton.textContent = 'تسجيل الدخول';
                    forms.loginForm.onsubmit = (event) => handleAuth(event, false);
                } else {
                    await account.createEmailSession(email, password);
                    showNotification('تم تسجيل الدخول بنجاح!', 'success');
                    await checkUserSession(true); // تحديث الواجهة بعد تسجيل الدخول
                }
            } catch (error) {
                console.error('Authentication Error:', error);
                showNotification(error.message, 'error');
            }
        }

        /**
         * تعديل: التحقق من جاهزية التطبيق قبل السماح بالبحث
         */
        async function handleSearch(e) {
            e.preventDefault();
            if (!appState.isReady) return;

            const destination = forms.searchForm.destination.value.trim();
            if (!destination) {
                showNotification('الرجاء إدخال وجهة البحث.', 'error');
                return;
            }

            views.loader.classList.remove('hidden-view'); // إظهار التحميل يدوياً
            views.home.classList.add('hidden-view');
            views.results.classList.add('hidden-view');


            try {
                let hotelsList;
                if (!isAppwriteConfigured) {
                    await new Promise(res => setTimeout(res, 1000));
                    hotelsList = generateMockHotels(10, destination).map(h => ({ ...h, $id: h.id }));
                } else {
                    const response = await databases.listDocuments(
                        DATABASE_ID,
                        HOTELS_COLLECTION_ID,
                        [ Query.search('city', destination) ]
                    );
                    hotelsList = response.documents;
                }
                
                appState.hotels = hotelsList.map(hotel => ({
                    ...hotel,
                    min_price: hotel.min_price || Math.floor(300 + Math.random() * 700)
                }));
                
                renderResults();
                showView('results');

            } catch (error) {
                console.error('Search Error:', error);
                showNotification('حدث خطأ أثناء البحث. يرجى المحاولة مرة أخرى.', 'error');
                showView('home');
            }
        }
        
        async function handleHotelSelection(hotelId) {
            if (!appState.isReady) return;
            showView('loader');
            try {
                 let hotel, rooms;
                 if (!isAppwriteConfigured) {
                    await new Promise(res => setTimeout(res, 1000));
                    hotel = appState.hotels.find(h => h.$id == hotelId);
                    rooms = generateMockRooms(hotelId, 5).map(r => ({ ...r, $id: r.id }));
                 } else {
                    hotel = await databases.getDocument(DATABASE_ID, HOTELS_COLLECTION_ID, hotelId);
                    const roomsResponse = await databases.listDocuments(
                        DATABASE_ID,
                        ROOMS_COLLECTION_ID,
                        [ Query.equal('hotel_id', hotelId) ]
                    );
                    rooms = roomsResponse.documents;
                 }
                 
                appState.selectedHotel = { hotel, rooms };
                renderHotelDetails();
                showView('hotel');

            } catch(error) {
                console.error('Hotel Selection Error:', error);
                showNotification('حدث خطأ في جلب تفاصيل الفندق.', 'error');
                showView('results');
            }
        }
        
        function handleBookingInitiation(roomId) {
            if (!appState.currentUser) {
                showNotification('يجب عليك تسجيل الدخول أولاً لإتمام الحجز.', 'error');
                showView('login');
                return;
            }

            const { hotel, rooms } = appState.selectedHotel;
            const room = rooms.find(r => r.$id == roomId);
            appState.selectedRoom = { ...room, hotelName: hotel.name };

            const checkin = otherElements.checkinDateInput.value;
            const confirmation = confirm(
`هل أنت متأكد من حجز غرفة "${room.type}" في فندق "${hotel.name}"؟
تاريخ الوصول: ${formatDate(checkin)}
السعر: ${formatCurrency(room.price_per_night)} لليلة الواحدة.`
            );
            
            if (confirmation) {
                completeBooking();
            }
        }

        async function completeBooking() {
            showView('loader');
            const room = appState.selectedRoom;
            const hotel = appState.selectedHotel.hotel;
            const user = appState.currentUser;
            const checkinDate = otherElements.checkinDateInput.value;
            
            const bookingData = {
                user_id: user.$id,
                hotel_id: hotel.$id,
                room_id: room.$id,
                check_in_date: checkinDate,
                total_price: room.price_per_night,
                guest_name: user.name || user.email,
                status: 'Confirmed'
            };

            try {
                let newBooking;
                if (!isAppwriteConfigured) {
                    await new Promise(res => setTimeout(res, 1000));
                    newBooking = { ...bookingData, $id: `mock_booking_${Date.now()}` };
                } else {
                    const permissions = [
                        Appwrite.Permission.read(Appwrite.Role.user(user.$id)),
                        Appwrite.Permission.update(Appwrite.Role.user(user.$id)),
                        Appwrite.Permission.delete(Appwrite.Role.user(user.$id)),
                    ];
                    newBooking = await databases.createDocument(
                        DATABASE_ID,
                        BOOKINGS_COLLECTION_ID,
                        ID.unique(),
                        bookingData,
                        permissions
                    );
                }
                
                appState.currentBooking = { booking: newBooking, hotel, room };
                renderConfirmation();
                
            } catch (error) {
                console.error('Booking Error:', error);
                showNotification('فشل الحجز. يرجى المحاولة مرة أخرى.', 'error');
                showView('hotel');
            }
        }

        async function handleShowMyBookings() {
            if (!appState.isReady || !appState.currentUser) {
                showNotification('الرجاء تسجيل الدخول لعرض حجوزاتك.', 'error');
                showView('login');
                return;
            }
            
            showView('loader');

            try {
                let bookings;
                if (!isAppwriteConfigured) {
                    await new Promise(res => setTimeout(res, 1000));
                    bookings = [
                        { $id: 'b1', hotel_id: 'h1', room_id: 'r1', check_in_date: '2025-12-20', total_price: 500, status: 'Confirmed' },
                        { $id: 'b2', hotel_id: 'h2', room_id: 'r2', check_in_date: '2025-11-15', total_price: 950, status: 'Confirmed' }
                    ];
                } else {
                    const response = await databases.listDocuments(
                        DATABASE_ID,
                        BOOKINGS_COLLECTION_ID,
                        [ Query.equal('user_id', appState.currentUser.$id) ]
                    );
                    bookings = response.documents;
                }
                
                const detailedBookings = await Promise.all(bookings.map(async (booking) => {
                    try {
                        const hotel = await databases.getDocument(DATABASE_ID, HOTELS_COLLECTION_ID, booking.hotel_id);
                        const room = await databases.getDocument(DATABASE_ID, ROOMS_COLLECTION_ID, booking.room_id);
                        return { ...booking, hotel, room };
                    } catch {
                        return { ...booking, hotel: { name: 'فندق محذوف' }, room: { type: 'غرفة محذوفة' } };
                    }
                }));

                renderMyBookings(detailedBookings);
                showView('myBookings');
            } catch (error) {
                console.error('Fetch Bookings Error:', error);
                showNotification('حدث خطأ في جلب الحجوزات.', 'error');
                showView('home');
            }
        }

        // ---------------------------------------------------------------------
        // القسم 7: إدارة المصادقة (Authentication Management)
        // ---------------------------------------------------------------------

        async function handleLogout() {
            try {
                await account.deleteSession('current');
                await checkUserSession(true);
                showNotification('تم تسجيل الخروج بنجاح.', 'success');
            } catch (error) {
                console.error('Logout Error:', error);
                showNotification('حدث خطأ أثناء تسجيل الخروج', 'error');
            }
        }

        /**
         * تعديل: الدالة الآن تحدث الواجهة وتضبط حالة الجاهزية
         * @param {boolean} forceHome - هل يجب الانتقال للرئيسية دائماً؟
         */
        async function checkUserSession(forceHome = false) {
            try {
                appState.currentUser = await account.get();
            } catch (error) {
                appState.currentUser = null;
            } finally {
                renderNav();
                // فقط عند التحميل الأولي أو الخروج، اذهب للرئيسية
                if (forceHome || !appState.isReady) {
                    showView('home');
                }
                appState.isReady = true; // <-- تعديل: التطبيق جاهز الآن
            }
        }
        
        // ---------------------------------------------------------------------
        // القسم 8: ربط الأحداث (Event Listeners Setup)
        // ---------------------------------------------------------------------

        function initializeApp() {
            document.addEventListener('DOMContentLoaded', async () => {
                setMinCheckinDate();
                
                // تعديل: انتظر حتى يتم التحقق من المستخدم قبل ربط الأحداث
                await checkUserSession();
                
                forms.loginForm.addEventListener('submit', (e) => handleAuth(e, false));
                forms.searchForm.addEventListener('submit', handleSearch);

                nav.logo.addEventListener('click', (e) => { e.preventDefault(); showView('home'); });
                nav.homeLink.addEventListener('click', (e) => { e.preventDefault(); showView('home'); });
                nav.loginLink.addEventListener('click', (e) => { e.preventDefault(); showView('login'); });
                nav.logoutButton.addEventListener('click', handleLogout);
                nav.myBookingsLink.addEventListener('click', (e) => { e.preventDefault(); handleShowMyBookings(); });
                
                otherElements.signupInsteadLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    const submitButton = forms.loginForm.querySelector('button[type="submit"]');
                    submitButton.textContent = 'إنشاء حساب جديد';
                    forms.loginForm.onsubmit = (event) => handleAuth(event, true);
                });
                
                otherElements.backToHomeBtn.addEventListener('click', () => showView('home'));
            });
        }
        
        // ---------------------------------------------------------------------
        // القسم 9: بيانات محاكاة (Mock Data)
        // ---------------------------------------------------------------------
        
        function generateMockHotels(count, city) {
            const mockHotels = [];
            const cities = ["دبي", "الرياض", "القاهرة", "جدة", "أبوظبي"];
            const hotelNames = ["جراند حياة", "هيلتون", "شيراتون", "فور سيزونز", "ريتز كارلتون"];
            const descriptions = [
                "فندق فاخر يقدم تجربة إقامة لا مثيل لها مع إطلالات خلابة على المدينة.",
                "يتميز بموقعه الاستراتيجي في قلب المدينة، ويوفر وصولاً سهلاً إلى المعالم السياحية.",
                "مثالي لرجال الأعمال والعائلات على حد سواء، مع خدمات ومرافق متكاملة.",
                "وجهة للاسترخاء والراحة، مع سبا عالمي ومطاعم فاخرة."
            ];
            const amenities = [ "واي فاي مجاني", "مسبح", "موقف سيارات", "نادي رياضي", "سبا", "خدمة غرف"];

            for (let i = 1; i <= count; i++) {
                const hotelCity = city || cities[i % cities.length];
                mockHotels.push({
                    id: `mock_hotel_${i}`,
                    name: `${hotelNames[i % hotelNames.length]} ${hotelCity}`,
                    city: hotelCity,
                    country: "الإمارات",
                    address: `شارع الشيخ زايد ${i}, ${hotelCity}`,
                    description: descriptions[i % descriptions.length],
                    image_url: `https://placehold.co/400x250/007BFF/FFFFFF?text=فندق+${i}`,
                    rating: (3.5 + Math.random() * 1.5).toFixed(1),
                    amenities: amenities.slice(0, 3 + Math.floor(Math.random() * 3)),
                    min_price: 300 + Math.floor(Math.random() * 700)
                });
            }
            return mockHotels;
        }

        function generateMockRooms(hotelId, count) {
            const mockRooms = [];
            const roomTypes = ["غرفة فردية", "غرفة مزدوجة", "جناح صغير", "جناح فاخر", "غرفة عائلية"];

            for (let i = 1; i <= count; i++) {
                mockRooms.push({
                    id: `mock_room_${hotelId}_${i}`,
                    hotel_id: hotelId,
                    type: roomTypes[i % roomTypes.length],
                    price_per_night: 200 + Math.floor(Math.random() * 800),
                    capacity: 1 + Math.floor(Math.random() * 4),
                    image_url: `https://placehold.co/400x300/4CAF50/FFFFFF?text=غرفة+${i}`
                });
            }
            return mockRooms;
        }

        // ---------------------------------------------------------------------
        // القسم 10: نقطة انطلاق التطبيق
        // ---------------------------------------------------------------------

        initializeApp();

    </script>
</body>
</html>
